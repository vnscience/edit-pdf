<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Editor Pro</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';</script>
    <script src="https://unpkg.com/interactjs/dist/interact.min.js"></script>

    <style>
        body { background-color: #f3f4f6; }
        
        #pdf-wrapper {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transform-origin: top left;
            transition: transform 0.1s ease-out;
        }

        /* --- DRAGGABLE ITEMS UX --- */
        .draggable-item {
            position: absolute;
            box-sizing: border-box;
            user-select: none;
            touch-action: none;
            cursor: grab;
            transform: translate(0px, 0px);
        }

        .draggable-item:active {
            cursor: grabbing;
        }

        /* Trạng thái được chọn */
        .draggable-item.is-selected {
            outline: 2px solid #2563eb;
            background-color: rgba(37, 99, 235, 0.05);
            z-index: 50;
        }

        /* Tay cầm giả lập để dễ click */
        .draggable-item.is-selected::before {
            content: '';
            position: absolute;
            top: -10px; left: -10px; right: -10px; bottom: -10px;
            border: 1px dashed rgba(37, 99, 235, 0.3);
            pointer-events: none;
            border-radius: 4px;
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="h-screen flex flex-col font-sans overflow-hidden text-gray-800">

    <!-- HEADER -->
    <header class="bg-white border-b border-gray-200 z-30 h-16 flex items-center justify-between px-4 shrink-0 shadow-sm">
        <div class="flex items-center gap-3">
            <div class="bg-red-600 text-white p-1.5 rounded flex items-center justify-center w-8 h-8">
                <i class="fas fa-file-pdf"></i>
            </div>
            <h1 class="text-lg font-bold text-gray-700 hidden lg:block">PDF Editor <span class="text-xs font-normal text-blue-600 bg-blue-50 px-2 py-0.5 rounded-full">v1.0</span></h1>
            
            <!-- Zoom Controls -->
            <div class="flex items-center bg-gray-100 rounded-md p-0.5 ml-2 border border-gray-200">
                <button onclick="changeZoom(-0.1)" class="w-7 h-7 flex items-center justify-center rounded hover:bg-white hover:shadow-sm text-gray-600 transition" title="Thu nhỏ">
                    <i class="fas fa-minus text-xs"></i>
                </button>
                <span id="zoom-level" class="text-xs font-bold text-gray-600 min-w-[45px] text-center select-none">100%</span>
                <button onclick="changeZoom(0.1)" class="w-7 h-7 flex items-center justify-center rounded hover:bg-white hover:shadow-sm text-gray-600 transition" title="Phóng to">
                    <i class="fas fa-plus text-xs"></i>
                </button>
            </div>
        </div>

        <!-- Pagination -->
        <div id="pagination-controls" class="flex items-center gap-2 bg-white border border-gray-200 rounded-md px-2 py-1 shadow-sm hidden">
            <button onclick="changePage(-1)" class="w-6 h-6 flex items-center justify-center rounded hover:bg-gray-100 disabled:opacity-30 text-gray-600" id="btnPrev">
                <i class="fas fa-chevron-left text-xs"></i>
            </button>
            <span class="text-sm font-semibold text-gray-700 select-none">
                Trang <span id="page-num">0</span> / <span id="page-count">0</span>
            </span>
            <button onclick="changePage(1)" class="w-6 h-6 flex items-center justify-center rounded hover:bg-gray-100 disabled:opacity-30 text-gray-600" id="btnNext">
                <i class="fas fa-chevron-right text-xs"></i>
            </button>
        </div>

        <!-- Main Tools -->
        <div class="flex items-center gap-2">
            <label class="btn-tool bg-blue-50 text-blue-700 border border-blue-100 hover:bg-blue-100">
                <i class="fas fa-folder-open"></i> <span class="hidden md:inline ml-1.5">Mở PDF</span>
                <input type="file" id="inpPdf" accept="application/pdf" class="hidden">
            </label>
            
            <div class="h-6 w-px bg-gray-300 mx-1"></div>
            
            <!-- Removed Text Button -->
            
            <label id="btnAddImgLabel" class="btn-tool bg-white border border-gray-300 text-gray-700 hover:bg-gray-50 opacity-50 cursor-not-allowed">
                <i class="fas fa-image text-gray-500"></i> <span class="hidden md:inline ml-1.5">Thêm Ảnh</span>
                <input type="file" id="inpImg" accept="image/*" class="hidden" disabled>
            </label>
            
            <div class="h-6 w-px bg-gray-300 mx-1"></div>
            
            <button id="btnSave" disabled onclick="savePDF()" class="btn-tool bg-green-600 text-white border border-green-600 hover:bg-green-700 shadow-sm disabled:opacity-50">
                <i class="fas fa-save"></i> <span class="ml-1.5 font-semibold">Lưu File</span>
            </button>
        </div>
    </header>

    <!-- DELETE BUTTON (Floating, replaces Property Bar) -->
    <div id="delete-bar" class="absolute top-20 left-1/2 transform -translate-x-1/2 bg-white border border-gray-200 shadow-xl rounded-lg h-12 flex items-center px-4 gap-4 hidden z-50 animate-fade-in-up">
        <span class="text-gray-500 font-medium text-sm">Ảnh đang chọn</span>
        <button onclick="deleteSelected()" class="bg-red-50 text-red-500 hover:text-red-700 hover:bg-red-100 px-3 py-1.5 rounded transition flex items-center gap-2" title="Xóa ảnh này">
            <i class="fas fa-trash-alt"></i> <span>Xóa</span>
        </button>
    </div>

    <!-- MAIN WORKSPACE -->
    <main class="flex-1 bg-gray-200/50 overflow-auto flex justify-center p-8 relative no-scrollbar select-none" id="main-container">
        <div id="pdf-wrapper" class="relative bg-white hidden shadow-2xl">
            <canvas id="the-canvas" class="block"></canvas>
            <div id="overlay-layer" class="absolute inset-0 z-10 overflow-hidden pointer-events-none"></div>
        </div>
        
        <div id="loading-msg" class="absolute inset-0 flex flex-col items-center justify-center bg-white/80 z-50 hidden backdrop-blur-sm">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mb-4"></div>
            <p class="text-gray-600 font-medium animate-pulse">Đang xử lý...</p>
        </div>
        
        <div id="empty-state" class="flex flex-col items-center justify-center h-full text-gray-400">
            <div class="bg-white p-8 rounded-full shadow-sm mb-4">
                <i class="fas fa-images fa-4x text-blue-100"></i>
            </div>
            <h2 class="text-xl font-semibold text-gray-600">Chèn Hình Ảnh vào PDF</h2>
            <p class="mt-2 text-sm text-gray-500">Tải lên file PDF để bắt đầu</p>
        </div>
    </main>

<style>
    .btn-tool {
        display: flex; align-items: center; justify-content: center;
        padding: 0.5rem 0.75rem; border-radius: 0.5rem; transition: all 0.2s; cursor: pointer; font-size: 0.875rem;
    }
    .animate-fade-in-up { animation: fadeInUp 0.2s ease-out; }
    @keyframes fadeInUp {
        from { opacity: 0; transform: translate(-50%, 10px); }
        to { opacity: 1; transform: translate(-50%, 0); }
    }
</style>

<script>
    // --- VARIABLES ---
    const { PDFDocument } = PDFLib; // Không cần Font hay Fontkit nữa
    let pdfDoc = null;          
    let pdfBytes = null;        
    
    let currentZoom = 1.0; 
    let baseViewport = null;
    let selectedEl = null;      
    
    let currentPage = 1;
    let totalPages = 0;
    
    const pagesData = new Map();

    const wrapper = document.getElementById('pdf-wrapper');
    const overlay = document.getElementById('overlay-layer');
    const deleteBar = document.getElementById('delete-bar');
    const loadingMsg = document.getElementById('loading-msg');
    const paginationControls = document.getElementById('pagination-controls');

    // --- 1. UPLOAD & RENDER ---
    document.getElementById('inpPdf').addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        showLoading(true);

        try {
            pdfBytes = await file.arrayBuffer();
            const loadingTask = pdfjsLib.getDocument(pdfBytes);
            pdfDoc = await loadingTask.promise;
            
            totalPages = pdfDoc.numPages;
            currentPage = 1;
            currentZoom = 1.0;
            pagesData.clear();
            
            await renderPage(currentPage);
            
            document.getElementById('empty-state').classList.add('hidden');
            wrapper.classList.remove('hidden');
            paginationControls.classList.remove('hidden');
            enableTools(true);
            updatePaginationUI();
            updateZoomUI();
        } catch (err) {
            console.error(err);
            alert("Lỗi đọc file PDF! Vui lòng thử file khác.");
        }
        showLoading(false);
    });

    async function renderPage(num) {
        const page = await pdfDoc.getPage(num);
        baseViewport = page.getViewport({ scale: 1.0 });
        
        const renderScale = 1.5 * currentZoom;
        const viewport = page.getViewport({ scale: renderScale });
        
        const canvas = document.getElementById('the-canvas');
        const ctx = canvas.getContext('2d');

        canvas.height = viewport.height;
        canvas.width = viewport.width;
        wrapper.style.width = `${viewport.width}px`;
        wrapper.style.height = `${viewport.height}px`;

        await page.render({ canvasContext: ctx, viewport: viewport }).promise;
        loadElementsForPage(num);
    }

    // --- 2. ZOOM LOGIC ---
    async function changeZoom(delta) {
        const newZoom = Math.round((currentZoom + delta) * 10) / 10;
        if (newZoom < 0.5 || newZoom > 3.0) return;
        saveCurrentPageData();
        currentZoom = newZoom;
        updateZoomUI();
        showLoading(true);
        await renderPage(currentPage);
        showLoading(false);
    }
    function updateZoomUI() { document.getElementById('zoom-level').innerText = Math.round(currentZoom * 100) + '%'; }

    // --- 3. PAGINATION ---
    async function changePage(delta) {
        const newPage = currentPage + delta;
        if (newPage < 1 || newPage > totalPages) return;
        saveCurrentPageData();
        currentPage = newPage;
        showLoading(true);
        await renderPage(currentPage);
        updatePaginationUI();
        showLoading(false);
    }
    function updatePaginationUI() {
        document.getElementById('page-num').innerText = currentPage;
        document.getElementById('page-count').innerText = totalPages;
        document.getElementById('btnPrev').disabled = currentPage <= 1;
        document.getElementById('btnNext').disabled = currentPage >= totalPages;
    }

    // --- 4. DATA MANAGEMENT ---
    function saveCurrentPageData() {
        const items = [];
        const scaleFactor = 1 / (1.5 * currentZoom);

        Array.from(overlay.children).forEach(el => {
            const domX = parseFloat(el.dataset.x) || 0;
            const domY = parseFloat(el.dataset.y) || 0;
            
            items.push({
                type: 'image', // Chỉ còn loại image
                x: domX * scaleFactor,
                y: domY * scaleFactor,
                width: parseFloat(el.style.width) * scaleFactor,
                height: parseFloat(el.style.height) * scaleFactor,
                imgData: el.dataset.imgData
            });
        });
        pagesData.set(currentPage, items);
    }

    function loadElementsForPage(pageNum) {
        overlay.innerHTML = '';
        deselectAll();

        const items = pagesData.get(pageNum) || [];
        const scaleFactor = 1.5 * currentZoom;

        items.forEach(item => {
            // Re-create Image Element
            const el = document.createElement('div');
            el.classList.add('draggable-item');
            el.className += " bg-cover bg-no-repeat border border-transparent hover:border-blue-300";
            
            const pixelX = item.x * scaleFactor;
            const pixelY = item.y * scaleFactor;
            
            el.dataset.x = pixelX;
            el.dataset.y = pixelY;
            el.style.transform = `translate(${pixelX}px, ${pixelY}px)`;
            el.style.pointerEvents = 'auto';
            el.dataset.type = 'image';

            el.style.width = (item.width * scaleFactor) + 'px';
            el.style.height = (item.height * scaleFactor) + 'px';
            el.style.backgroundImage = `url('${item.imgData}')`;
            el.dataset.imgData = item.imgData;
            
            el.addEventListener('mousedown', (e) => { e.stopPropagation(); selectItem(el); });
            overlay.appendChild(el);
        });
    }

    // --- 5. IMAGE ADDING ---
    document.getElementById('inpImg').addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (evt) => {
            const img = new Image();
            img.onload = () => {
                const el = document.createElement('div');
                el.classList.add('draggable-item');
                el.className += " bg-cover bg-no-repeat border border-transparent hover:border-blue-300";
                
                // Mặc định vị trí
                el.dataset.x = 50; el.dataset.y = 50;
                el.style.transform = `translate(50px, 50px)`;
                el.style.pointerEvents = 'auto';
                el.dataset.type = 'image';

                // Size ảnh
                const ratio = img.height / img.width;
                const baseW = 200 * currentZoom;
                el.style.width = `${baseW}px`;
                el.style.height = `${baseW * ratio}px`;
                el.style.backgroundImage = `url('${evt.target.result}')`;
                el.dataset.imgData = evt.target.result;

                el.addEventListener('mousedown', (e) => { e.stopPropagation(); selectItem(el); });

                overlay.appendChild(el);
                selectItem(el);
            }
            img.src = evt.target.result;
        };
        reader.readAsDataURL(file);
        e.target.value = '';
    });

    // --- 6. INTERACT JS ---
    interact('.draggable-item')
        .draggable({
            listeners: {
                move(event) {
                    const target = event.target;
                    const x = (parseFloat(target.dataset.x) || 0) + event.dx;
                    const y = (parseFloat(target.dataset.y) || 0) + event.dy;
                    target.style.transform = `translate(${x}px, ${y}px)`;
                    target.dataset.x = x; target.dataset.y = y;
                }
            },
            modifiers: [ interact.modifiers.restrictRect({ restriction: 'parent', endOnly: true }) ]
        })
        .resizable({
            edges: { left: true, right: true, bottom: true, top: true },
            listeners: {
                move(event) {
                    const target = event.target;
                    let x = (parseFloat(target.dataset.x) || 0);
                    let y = (parseFloat(target.dataset.y) || 0);
                    target.style.width = event.rect.width + 'px';
                    target.style.height = event.rect.height + 'px';
                    x += event.deltaRect.left; y += event.deltaRect.top;
                    target.style.transform = `translate(${x}px, ${y}px)`;
                    target.dataset.x = x; target.dataset.y = y;
                }
            }
        });

    // --- 7. SELECTION ---
    document.getElementById('main-container').addEventListener('mousedown', (e) => {
        if (e.target.id === 'main-container' || e.target.id === 'overlay-layer' || e.target.id === 'pdf-wrapper') deselectAll();
    });

    function selectItem(el) {
        deselectAll();
        selectedEl = el;
        el.classList.add('is-selected');
        deleteBar.classList.remove('hidden');
    }

    function deselectAll() {
        if (selectedEl) selectedEl.classList.remove('is-selected');
        selectedEl = null;
        deleteBar.classList.add('hidden');
    }

    function deleteSelected() { if (selectedEl) { selectedEl.remove(); deselectAll(); } }

    // --- 8. SAVE PDF ---
    async function savePDF() {
        if (!pdfBytes) return;
        showLoading(true);
        saveCurrentPageData(); 

        try {
            const pdfDocLib = await PDFDocument.load(pdfBytes);
            const pages = pdfDocLib.getPages();

            for (const [pageNum, items] of pagesData.entries()) {
                if (items.length === 0) continue;
                const pageIndex = pageNum - 1;
                if (pageIndex >= pages.length) continue;
                
                const pdfPage = pages[pageIndex];
                const { height: pdfHeight } = pdfPage.getSize();

                for (let item of items) {
                    const pdfX = item.x;
                    const pdfY = pdfHeight - item.y - item.height; // Y ảnh tính từ bottom-left

                    try {
                        let embeddedImg;
                        if (item.imgData.startsWith('data:image/png')) {
                            embeddedImg = await pdfDocLib.embedPng(item.imgData);
                        } else {
                            embeddedImg = await pdfDocLib.embedJpg(item.imgData);
                        }
                        
                        pdfPage.drawImage(embeddedImg, {
                            x: pdfX, y: pdfY, 
                            width: item.width, height: item.height
                        });
                    } catch (imgErr) {
                        console.error("Image error:", imgErr);
                    }
                }
            }

            const pdfDataUri = await pdfDocLib.saveAsBase64({ dataUri: true });
            const link = document.createElement('a');
            link.href = pdfDataUri;
            link.download = 'edited_file_images.pdf';
            link.click();

        } catch (err) {
            console.error(err);
            alert("Lỗi nghiêm trọng khi lưu file: " + err.message);
        }
        showLoading(false);
    }

    function enableTools(enabled) {
        document.getElementById('inpImg').disabled = !enabled;
        document.getElementById('btnSave').disabled = !enabled;
        const imgLabel = document.getElementById('btnAddImgLabel');
        if(enabled) {
            imgLabel.classList.remove('opacity-50', 'cursor-not-allowed');
            imgLabel.classList.add('hover:bg-gray-50', 'cursor-pointer');
        } else {
            imgLabel.classList.add('opacity-50', 'cursor-not-allowed');
        }
    }
    function showLoading(show) { loadingMsg.classList.toggle('hidden', !show); }
</script>
</body>
</html>
